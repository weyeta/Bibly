<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Esc치ner de C칩digos</title>
  <style>
    body {
      font-family: sans-serif;
      font-size: 1.2rem;
      padding: 1rem;
      background: #f9f9f9;
    }
    .scanner-container {
      position: relative;
      width: 100%;
    }
    video {
      width: 100%;
      height: auto;
      background: black;
    }
    .overlay {
      position: absolute;
      top: 25%;
      left: 25%;
      width: 50%;
      height: 50%;
      border: 3px dashed #00cc00;
      pointer-events: none;
      box-sizing: border-box;
    }
    #output {
      font-weight: bold;
      color: green;
      margin-top: 1rem;
    }
    .error {
      color: red;
    }
    canvas {
      display: none;
    }
  </style>
</head>
<body>
  <h2>游닝 Escane치 un c칩digo</h2>

  <label for="cameraSelect">Seleccion치 la c치mara:</label>
  <select id="cameraSelect"></select>

  <div class="scanner-container">
    <video id="preview" autoplay playsinline></video>
    <div class="overlay"></div>
  </div>

  <p><strong>Resultado:</strong> <span id="output">...</span></p>
  <p id="errorMsg" class="error"></p>

  <canvas id="canvas"></canvas>

  <script src="https://cdn.jsdelivr.net/npm/@zxing/library@latest"></script>

  <script>
    const codeReader = new ZXing.BrowserMultiFormatReader();
    const videoElement = document.getElementById('preview');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const output = document.getElementById('output');
    const cameraSelect = document.getElementById('cameraSelect');
    const errorMsg = document.getElementById('errorMsg');

    let videoStream = null;
    let decodeInterval = null;
    let allCameras = [];

    async function listCameras() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: true });
        stream.getTracks().forEach(track => track.stop());

        const devices = await navigator.mediaDevices.enumerateDevices();
        const videoDevices = devices.filter(d => d.kind === 'videoinput');

        cameraSelect.innerHTML = '';
        videoDevices.forEach((device, index) => {
          const option = document.createElement('option');
          option.value = device.deviceId;
          option.text = device.label || `C치mara ${index + 1}`;
          cameraSelect.appendChild(option);
        });

        allCameras = videoDevices;
        return videoDevices;
      } catch (err) {
        errorMsg.textContent = 'Error al listar c치maras: ' + err.message;
        return [];
      }
    }

    async function startScanner(deviceId) {
      if (videoStream) {
        videoStream.getTracks().forEach(track => track.stop());
      }
      if (decodeInterval) {
        clearInterval(decodeInterval);
      }

      try {
        const stream = await navigator.mediaDevices.getUserMedia({
          video: { deviceId: { exact: deviceId } }
        });
        videoElement.srcObject = stream;
        videoStream = stream;

        videoElement.onloadedmetadata = () => {
          videoElement.play();
          setTimeout(startCroppingLoop, 500); // Esperar a que el video est칠 listo
        };
      } catch (err) {
        errorMsg.textContent = 'Error al acceder a la c치mara: ' + err.message;
      }
    }

    function startCroppingLoop() {
      decodeInterval = setInterval(async () => {
        if (videoElement.videoWidth === 0 || videoElement.videoHeight === 0) return;

        const vw = videoElement.videoWidth;
        const vh = videoElement.videoHeight;
        const cropWidth = vw * 0.5;
        const cropHeight = vh * 0.5;
        const cropX = (vw - cropWidth) / 2;
        const cropY = (vh - cropHeight) / 2;

        canvas.width = cropWidth;
        canvas.height = cropHeight;
        ctx.drawImage(videoElement, cropX, cropY, cropWidth, cropHeight, 0, 0, cropWidth, cropHeight);

        try {
          const result = await codeReader.decodeFromCanvas(canvas);
          output.textContent = result.text;
          clearInterval(decodeInterval);
          videoStream.getTracks().forEach(track => track.stop());
        } catch (e) {
          // sigue escaneando
        }
      }, 300);
    }

    cameraSelect.addEventListener('change', () => {
      const newId = cameraSelect.value;
      startScanner(newId);
    });

    (async () => {
      const cameras = await listCameras();
      if (cameras.length > 0) {
        await startScanner(cameras[0].deviceId);
      } else {
        errorMsg.textContent = 'No se encontraron c치maras.';
      }
    })();
  </script>
</body>
</html>
