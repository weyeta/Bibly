<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Esc치ner de C칩digos</title>
  <script type="module">
    import {
      BrowserMultiFormatReader
    } from 'https://cdn.jsdelivr.net/npm/@zxing/browser@0.0.10/+esm';

    const codeReader = new BrowserMultiFormatReader();
    let selectedDeviceId = null;
    let isScanning = false;
    const scannedCodes = new Set();

    const startScan = async () => {
      if (!selectedDeviceId) {
        const devices = await BrowserMultiFormatReader.listVideoInputDevices();
        if (devices.length > 0) {
          selectedDeviceId = devices[0].deviceId;
        } else {
          alert('No se encontraron c치maras.');
          return;
        }
      }

      codeReader.decodeFromVideoDevice(selectedDeviceId, 'video', (result, err) => {
        if (result) {
          const code = result.getText();
          if (!scannedCodes.has(code)) {
            scannedCodes.add(code);
            addCodeToList(code);
          }
        }
      });
    };

    const stopScan = () => {
      codeReader.reset();
    };

    const addCodeToList = (code) => {
      const list = document.getElementById('code-list');
      const li = document.createElement('li');
      li.textContent = code;
      list.appendChild(li);
    
      // Beep
      const ctx = new (window.AudioContext || window.webkitAudioContext)();
      const osc = ctx.createOscillator();
      const gain = ctx.createGain();
      osc.type = 'square';
      osc.frequency.value = 800;
      gain.gain.value = 0.2;
      osc.connect(gain);
      gain.connect(ctx.destination);
      osc.start();
      osc.stop(ctx.currentTime + 0.1);
    
      // Vibraci칩n
      if (navigator.vibrate) {
        navigator.vibrate(100); // vibra 100ms
      }
    };
    window.onload = async () => {
      const toggleButton = document.getElementById('toggle-scan');
      toggleButton.addEventListener('click', async () => {
        if (isScanning) {
          stopScan();
          toggleButton.textContent = 'Iniciar escaneo';
        } else {
          await startScan();
          toggleButton.textContent = 'Detener escaneo';
        }
        isScanning = !isScanning;
      });
    };
  </script>
  <style>
    body {
      font-family: sans-serif;
      text-align: center;
      margin-top: 20px;
    }
    #video {
      width: 100%;
      max-width: 400px;
      height: auto;
      border: 1px solid #ccc;
    }
    ul {
      list-style: none;
      padding: 0;
      margin-top: 20px;
    }
    li {
      background: #e0ffe0;
      margin: 4px auto;
      padding: 8px;
      max-width: 300px;
      border-radius: 4px;
    }
    button {
      margin-top: 10px;
      padding: 10px 20px;
      font-size: 1em;
    }
  </style>
</head>
<body>
  <video id="video" autoplay muted></video>
  <br />
  <button id="toggle-scan">Iniciar escaneo</button>
  <ul id="code-list"></ul>
</body>
</html>
